---
title: "E. turcicum x flutriafol model selection and analysis"
author: "Austin McCoy"
date: "1/11/2023"
output: 
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# These scripts were originally made by Dr. Mikaela Breunig and Dr. Zachary Noel for use in a Fusarium x Adepidyn fungicide sensitivity study. Here, we are using these scripts to determine the best model choice for a Exserohilum turcicum (Syn = Setosphaeria turcicum) and flutriafol fungicide study


```{r, include=FALSE}
rm(list = ls(all=TRUE)) 
options(scipen = 999) 
```

function to load any packages that we desire. This is hidden in the .html file, but is present within the .Rmd file.
```{r, eval=TRUE, warning=FALSE, message=FALSE, include=FALSE}

packages <- c("broom","stringr", "tidyverse","ggplot2", "drc","lattice","car", "lme4", "lsmeans", "plyr", "plotrix", "knitr", "ggplot2", "lmtest", "lmerTest", "Rmisc", "gridExtra", "plotly", "webshot", "ggpmisc", "ggsci","scales", "readxl", "cowplot", "openxlsx")

lapply(packages, library, character.only=TRUE)

#library(cowplot)
#library(openxlsx)

```

Loading in raw data to restructure into R-friendly format
```{r}
raw_data <- read_excel("E. turcicum flutriafol sensitivity data for Austin_batch_rep.xlsx")
raw_data
```

Restructuring data
```{r}
data_long <- gather(raw_data, ppm, diameter, '0 ug/ml':'100 ug/ml', factor_key = TRUE) # changing the data to long format instead of wide format

raw_data_long <- select(data_long, select = -c(EC50)) # removing the EC50 column from this long data set, we will calculate new ones further down with a model that works best for the isolates fungicide x growth interaction

raw_data_long$ppm <- gsub(pattern = " ug/ml", replacement = "", x = raw_data_long$ppm) # getting rid of " ug/ml" suffix, so that data will be able to read as numeric. important for EC50 calculations

raw_data_long$isolate <- gsub(pattern="-", replacement="_", x=raw_data_long$isolate) # removing the dash as it produces problems later on

raw_data_long$isolate <- paste0('ET', raw_data_long$isolate) #adding the prefix "ET" for Exserohilum turcicum, "drc" package doesnt like isolate names that start with a number. so we just add the character prefix here. Otherwise, isolates names are as they were given to me, we can remove this prefix later if we prefer by using the "gsub" function as seen above.

raw_data_long # here is the new data structure and isolate names
```

Checking how many unique isolates were tested, irrespective of how many times they were tested
```{r}

IsolateData<-unique(raw_data_long$isolate) # 81 unique isolates, just figuring out how many isolates were tested, this does not show how many times each was tested

IsolateData
# Florida = 5
# Iowa = 6
# Illinois = 3
# Indiana = 34
# Kentucky = 7
# Louisiana = 5
# Missouri = 2
# Mississippi = 4
# Nebraska = 7
# Ohio = 3
# Pennsylvania = 2
# Tennessee = 3

unique_isolates <- raw_data_long


```

Processing data to go from raw diameters to a relative growth for each isolate
we are assuming that the plug diameter has already been subtracted from the growth of each isolate as there are 0's in the dataset already at higher concentrations
```{r}
turcicum_flutriafol <- raw_data_long %>% # dataset we are using
  group_by(isolate, batch) %>% # grouping them by isolate and batch tested, so each instance an isolate was tested will be summarised here
  mutate(avgC=mean(diameter[ppm==0])) %>% # Mean diameter of each isolate at 0ppm, used to calculate relative growth on next line
  mutate(relative_growth=round(diameter/avgC, digits=3)) # gives us the relative growth (relative to the 0ppm control) of each isolate, relative to the 0ppm control, down to the 3rd decimal point. Rounding to 3 decimal points was needed so that EC50 calculations could converge later on, prior there were 10-20 decimal points of data and the models could not converge

turcicum_flutriafol
```


```{r}
turcicum_flutriafol[turcicum_flutriafol <0] <- 0 ## removing negative relative growth values and replacing them with 0

turcicum_flutriafol$isolate <- as.factor(turcicum_flutriafol$isolate) #sets as factor

turcicum_flutriafol$ppm <- as.numeric(turcicum_flutriafol$ppm) # set as numeric

turcicum_flutriafol

mean_relgrowth_ppm <- turcicum_flutriafol %>%
  group_by(isolate, ppm) %>%
  summarise(mean_rel_growth=mean(relative_growth))


# inhibition groups for binnig by sensitivity
mean_relgrowth_ppm$isolate <- as.character(mean_relgrowth_ppm$isolate)

complete_inhib_1ppm <- mean_relgrowth_ppm %>%
  subset(., ppm=="1") %>%
  subset(., mean_rel_growth =="0")

com_inhib1ppm_isolates <- c(complete_inhib_1ppm$isolate)

complete_inhib_10ppm <- mean_relgrowth_ppm %>%
  subset(., ppm=="10") %>%
  subset(., mean_rel_growth=="0") %>%
  subset(., !isolate %in% com_inhib1ppm_isolates)

com_inhib10ppm_isolates <- c(complete_inhib_10ppm$isolate)

complete_inhib_100ppm <- mean_relgrowth_ppm %>%
  subset(., ppm=="100") %>%
  subset(., mean_rel_growth=="0") %>%
  subset(., !isolate %in% com_inhib10ppm_isolates) %>%
  subset(., !isolate %in% com_inhib1ppm_isolates)

no_inhib_100ppm <- mean_relgrowth_ppm %>%
  subset(., ppm=="100") %>%
  subset(., mean_rel_growth!="0")



#unique(turcicum_flutriafol$isolate)
```

Crude dose response curves for each isolate. Getting an idea how the relative growth data looks

```{r, fig.asp=0.8, fig.width=20, out.width="100%", dpi=600}
#### Crude Dose Response Curves #####

#turcicum_flutriafol$relative_growth <- as.numeric(turcicum_flutriafol$relative_growth)

turcicum_flutriafol$isolatexbatch <- interaction(turcicum_flutriafol$isolate, turcicum_flutriafol$batch, drop = TRUE) # this will add an additional column that is a unique identifier for each isolate x batch testing that was done. we can then use this to run our model selection and analysis on each isolate testing individually to look for growth differences across batches.

crude_drc_etrucicum <- ggplot(turcicum_flutriafol,aes(x = as.factor(ppm), y = relative_growth)) +
  stat_summary(fun=mean,position=position_dodge(width=0.95), geom="point") +
  #geom_line() +
  stat_smooth(method = "loess", se = FALSE, color = "black") +
  #scale_fill_manual(values=wes_palette(n=4, name="Moonrise2")) +
  stat_summary(fun.data = mean_se,position=position_dodge(width=0.95), geom = "errorbar", col= "#4d4d4d") +
  theme_gray() +
  facet_wrap(~isolatexbatch, ncol = 6)+
  guides(fill = FALSE) +
  ## scale_fill_manual(values = col[1:2]) +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  #scale_x_continuous(breaks=c(0, 0.00001, 0.0001, 0.005, 0.01, 1, 10, 50)) +
  ylim(0,2.50) +
  ggtitle("Dose Response Curves") +
  xlab("Concentration ") + ylab("Relative Growth")

crude_drc_etrucicum # this will be hard to see, so use the line of code below to save this document in high-resolution to your working directory

# you can use this next line to save this figure to your project directory (usually the folder that contains the .rmd and project R files)
#ggsave("crude dose response curves E.turcicum.png", plot=crude_drc_etrucicum, width=20, height=16, dpi = 600)

```


It looks like we have isolates which were notably resistant and we will likely not be able to determine an EC50 for them, or will need to use a significantly different model to do so. Here we will remove those isolate from the dataset for now
```{r}
# These isolates were notably resistant, or have some odd crude dose response curves, so we are removing them for now so they dont skew model testing for the other isolates
turcicum_flutriafol_nonegative <- turcicum_flutriafol %>%
  filter(isolatexbatch!="ET20KY6.8") %>%
  filter(isolatexbatch!="ET20IA2.9") %>%
  filter(isolatexbatch!="ET20IN16.9") %>%
  filter(isolatexbatch!="ET20FL4.10") %>%
  filter(isolatexbatch!="ET20MS4.11") %>%
  filter(isolatexbatch!="ET20IN53.7") %>%
  filter(isolatexbatch!="ET20IN65.12") %>%
  filter(isolatexbatch!="ET20FL8.13") %>% 
  filter(isolatexbatch!="ET20IA1.5")
# These are likely the 8 isolates missing from the data table in manuscript
```


We tested 3 different log-logistic models and 3 hormetic models on this dataset to find the best fit for these isolate x fungicide interactions. Below is information on each model tested:
```{r}
#func.list , would add any additional models here, their position becomes their number in the next step 
func.list <- list(LL.2(), LL.3(), LL.4(), BC.4(), CRS.4c(), W2.4())

# LL.2 = Two-parameter log-logistic model (Symmetric) - lower limit at 0, upper limit 1
# LL.3 = Three-parameter log-logistic model (Symmetric) - lower limit at 0
# LL.4 = Four-parameter log-logistic model (Symmetric) - upper limit at 1
# BC.4 = Brain and Cousens (Asymmetric - hormetic) - lower limit fixed at 0
# CRS.4c = Four-parameter Cedergreen-Ritz-Streibig (Asymmetric - hormetic) - lower limit 0
# W2.4 = Four-parameter Weibull2 (Asymmetric) type 2, lower limit at 0, upper limit at 1

# These were the models tested in Noel et al 2018 "Significant Influence of EC50 Estimation by Model Choice and EC50 Type" for Pythium oopapillum and Fusarium virguliforme. 

#There are more models we can test, but these should cover everything, if not ill add more and test again. We will likely go with one model for all isolates, unless there is a significant subset that needs a different model (i.e. hormesis, some symmetric and other asymmetric, etc)

# Symmetric = there is symmetry around an inflection point (EC50)
# Asymmetric = flexible to estimate different response relationships at low and high doses (i.e. no symmetry around an inflection point)
```

model selection function (log-likelihood, AIC).
```{r}

#creates the function "model.stats" that will determine the AIC and Loglikhood for each isolate individually(group_by isolate), input is the model
model.stats <- function(func.number){ # the () indicate what our input is for this to run. in this case it will be the number for the model in our "func.list" we made in the above chunk. i.e. 1 = LL.2, 2 = LL.3, and so on
  nested_df <- turcicum_flutriafol_nonegative %>% # dataset this function will run on
    group_by(isolatexbatch) %>% # testing each isolate x batch interaction sperately
    nest() %>% # nesting the datafrom to mutate
    mutate(drc = map(data, ~ drm(turcicum_flutriafol_nonegative$relative_growth*100 ~ turcicum_flutriafol_nonegative$ppm, fct = func.list[[func.number]], data = .))) #running the model we select from our function list on the data. a different number will run a different model, but dont change anything in this function. we will use it later to run each model
  
  stats <- map(nested_df$drc, ~data.frame(loglik = logLik(.x), 
                                          aic = AIC(.x))) %>%
                                          do.call(rbind.data.frame, .) # gather the log-likelihood and Aikoike information criterion for each isolate x batch interaction with the model
  
  stats$model <- func.list[[func.number]]$name # adding the model name to each aic and loglik score
  stats$isolatexbatch <- unique(turcicum_flutriafol_nonegative$isolatexbatch) # adding our unique isolate x batch dientifier so we know which model is the best for each isolate
  
  return(stats) # returning this stats data frame for the model selected
}

```


runs function according to that model number and outputs it in df 
```{r}
#LL2 <- model.stats(1) # running "model.stats" using the LL.2 model, throws an error on the first isolate, likely not good for hormetic data
LL3 <- model.stats(2) # running "model.stats" using the LL3 model
LL4 <- model.stats(3) # running "model.stats" using the LL4 model
#BC.4 <- model.stats(4) # running "model.stats" using the BC.4 model, throwing an error now that we have removed some isolates with weird growth
#CRS.4c <- model.stats(5) # running "model.stats" using the CRS.4c model, this will throw an error. likely not a good model for our data
W2.4 <- model.stats(6) # running "model.stats" using the W2.4 model

all.together <- rbind.data.frame(LL3,LL4,W2.4) # CRS.4c, LL2,BC.4,


min.aic <- all.together %>%
  group_by(isolatexbatch) %>% 
  nest() %>% 
  mutate(best.model = map(data, ~.$model[which.min(.$aic)])) 
View(min.aic) #LL.4 for all included in this analysis

max.LL <- all.together %>%
  group_by(isolatexbatch) %>% 
  nest() %>% 
  mutate(best.model = map(data, ~.$model[which.max(.$loglik)])) 
View(max.LL) #LL.4 again
```

Lets just verify this using a different method that also has a plot we can visualize the model fit with.
```{r}
#LL.2
LL.2_modelfit<-drm(formula = turcicum_flutriafol_nonegative$relative_growth ~ turcicum_flutriafol_nonegative$ppm, fct = LL.2(),type="continuous")
modelFit(LL.2_modelfit)
summary(LL.2_modelfit)
LL.2_plot <- plot(LL.2_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="relative growth", main="LL.2 Model")

# LL.3
LL.3_modelfit<-drm(formula = turcicum_flutriafol_nonegative$relative_growth ~ turcicum_flutriafol_nonegative$ppm, fct = LL.3(),type="continuous")
modelFit(LL.3_modelfit)
summary(LL.3_modelfit)
LL.3_plot <- plot(LL.3_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="relative growth", main="LL.3 Model")

# LL.4
LL.4a_modelfit<-drm(formula = turcicum_flutriafol_nonegative$relative_growth ~ turcicum_flutriafol_nonegative$ppm, fct = LL.4(),type="continuous")
modelFit(LL.4a_modelfit)
summary(LL.4a_modelfit)
LL.4_plot <- plot(LL.4a_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="relative growth", main="LL.4 Model")

#BC.4
BC.4_modelfit <- drm(formula = turcicum_flutriafol_nonegative$relative_growth ~ turcicum_flutriafol_nonegative$ppm, fct = BC.4(),type="continuous")
modelFit(BC.4_modelfit)
summary(BC.4_modelfit)
BC.4_plot <- plot(BC.4_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="relative growth", main="BC.4 Model")

#CRS.4c, convergence will fail. not a good model for our data
#CRS.4c_modelfit <- drm(formula = turcicum_flutriafol_nonegative$relative_growth ~ turcicum_flutriafol_nonegative$ppm, fct = CRS.4c(),type="continuous")
#modelFit(CRS.4c_modelfit)
#summary(CRS.4c_modelfit)
#CRS.4c_plot <- plot(CRS.4c_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="relative growth", main="CRS.4c Model")

#W2.4
W2.4_modelfit <- drm(formula = turcicum_flutriafol_nonegative$relative_growth ~ turcicum_flutriafol_nonegative$ppm, fct = W2.4(),type="continuous")
modelFit(W2.4_modelfit)
summary(W2.4_modelfit)
W2.4_plot <- plot(W2.4_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="relative growth", main="W2.4 Model")

# all plots together or a quick view
#jpeg("all models together.jpg", width = 480, height = 240)
#par(mfrow = c(2, 3))
#plot(LL.2_modelfit,xlab="",ylab="relative growth", main="LL.2 Model")
#plot(LL.3_modelfit,xlab="",ylab="", main="LL.3 Model")
#plot(LL.4a_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="", main="LL.4 Model")
#plot(BC.4_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="relative growth", main="BC.4 Model")
#plot(W2.4_modelfit,xlab="Flutriafol concentration (mg/L)",ylab="", main="W2.4 Model")
#dev.off()
# visually, we can see that LL.3, LL.4, BC.4, and W2.4 parameter models all fit well, but the LL.4 and W2.4 model had nearly identical model fits for this data.
```

One more way to test model fit, still showing LL4, W2.4, and BC.4 models are all around the same in terms of fit. Since Ive done everythin in LL.4 we are good, but maybe W2.4 just to compare.
```{r}
mselect(LL.2_modelfit, func.list)

```

EC50 calculations using the LL.4 model selected from above
```{r}
turcicum_flutriafol_nonegative # data set for reference
#unique(turcicum_flutriafol_nonegative$isolate)

drm.func_ll4 <- function(x) {
  try(drm(relative_growth*100 ~ ppm, 
          fct = LL.4(),
          type = "continuous",
          data = x)) 
} # makes the funciton "drm.func" that will run the LL.4 model across our isolates to calculate the EC50



EC50.try <- turcicum_flutriafol %>%
  group_by(isolatexbatch) %>% 
  nest() %>%
  mutate(drmod = map(data, drm.func_ll4)) %>%
  mutate(class.mod = map(drmod, class)) %>%
  unnest(class.mod) 

EC50.final_LL4 <- subset(EC50.try, class.mod != "try-error")
EC50.failed_LL4 <- subset(EC50.try, class.mod == "try-error")

ED.func_absolute <- function(x) {
  estimate <- try(data.frame(ED(x, type = "absolute", respLev = 0.50, display = FALSE)))
  EC50 <- try(estimate[[1]]) 
  return(EC50)
  
}

ED.func_relative <- function(x) {
  estimate <- try(data.frame(ED(x, type = "relative", respLev = 0.50, display = FALSE)))
  EC50 <- try(estimate[[1]]) 
  return(EC50)
  
}

Absolute.EC50_ll4 <- EC50.final_LL4 %>%
  mutate(Absolute.EC50.estimate_ll4 = map(drmod, ED.func_absolute)) %>%
  unnest(Absolute.EC50.estimate_ll4) %>%
  select(isolatexbatch, Absolute.EC50.estimate_ll4)

Relative.EC50_ll4 <- EC50.final_LL4 %>%
  mutate(Relative.EC50.estimate_ll4 = map(drmod, ED.func_relative)) %>%
  unnest(Relative.EC50.estimate_ll4) %>%
  select(isolatexbatch, Relative.EC50.estimate_ll4)

Relative_and_Absolute_EC50_ll4 <- merge(Absolute.EC50_ll4, Relative.EC50_ll4, by="isolatexbatch")

pander::pander(Relative_and_Absolute_EC50_ll4) # final dataset of Absolute and Relative EC50's. This includes everything except the isolates which were noticalby resistant or had very odd growth curves. Maybe we can just discuss those in the discussion, or chat about what we want to do about them later.

#write_csv(Relative_and_Absolute_EC50_ll4, "LL4 relative and aboslute ec50 eturcium x flutriafol_agm.csv") # you can output this data here to csv, or to excel using the write.xlsx() function from the package "openxlsx".

#W2.4 parameter estimations

turcicum_flutriafol

drm.func_w24 <- function(x) {
  try(drm(relative_growth*100 ~ ppm, 
          fct = W2.4(), 
          type = "continuous",
          data = x)) 
} # makes the funciton "drm.func" that will run the LL.4 model across our isolates to calculate the EC50



EC50.try_w24 <- turcicum_flutriafol %>%
  group_by(isolatexbatch) %>% 
  nest() %>%
  mutate(drmod = map(data, drm.func_w24)) %>%
  mutate(class.mod = map(drmod, class)) %>%
  unnest(class.mod) 

EC50.final_W24 <- subset(EC50.try_w24, class.mod != "try-error")
EC50.failed_W24 <- subset(EC50.try_w24, class.mod == "try-error")

ED.func_absolute <- function(x) {
  estimate <- try(data.frame(ED(x, type = "absolute", respLev = 0.50, display = FALSE)))
  EC50 <- try(estimate[[1]]) 
  return(EC50)
  
}

ED.func_relative <- function(x) {
  estimate <- try(data.frame(ED(x, type = "relative", respLev = 0.50, display = FALSE)))
  EC50 <- try(estimate[[1]]) 
  return(EC50)
  
}

Absolute.EC50_w24 <- EC50.final_W24 %>%
  mutate(Absolute.EC50.estimate_w24 = map(drmod, ED.func_absolute)) %>%
  unnest(Absolute.EC50.estimate_w24) %>%
  select(isolatexbatch, Absolute.EC50.estimate_w24)

Relative.EC50_w24 <- EC50.final_W24 %>%
  mutate(Relative.EC50.estimate_w24 = map(drmod, ED.func_relative)) %>%
  unnest(Relative.EC50.estimate_w24) %>%
  select(isolatexbatch, Relative.EC50.estimate_w24)

Relative_and_Absolute_EC50_w24 <- merge(Absolute.EC50_w24, Relative.EC50_w24, by="isolatexbatch", all=TRUE)

unique(Relative_and_Absolute_EC50_w24$isolatexbatch)

Relative_and_Absolute_EC50_w24

both_models_ec50 <- merge(Relative_and_Absolute_EC50_ll4, Relative_and_Absolute_EC50_w24, by="isolatexbatch", all=TRUE)

unique(Relative_and_Absolute_EC50_w24$isolatexbatch)

unique(both_models_ec50$isolatexbatch)

both_models_ec50

# t.test to see if W2.4 and LL.4 Absolute Ec50s are significantly different
t.test(both_models_ec50$Absolute.EC50.estimate_ll4, both_models_ec50$Absolute.EC50.estimate_w24) # not significantly different from each other

# Range and mean of Absolute EC50 values LL.4 and W2.4
summary(both_models_ec50)

#write_csv(both_models_ec50, "ll4 and W2.4 models relative and absolute ec50 values.csv")
```
looking at dose response curves for those isolates we couldnt calculate an EC50 for, using the LL4 model
```{r}
list_noabs_ll4 <- list("ET20FL5.13", "ET20FL5.16", "ET20FL9.12", "ET20IN3.8", "ET20IN67.11", "ET20KY5.8", "ET20KY6.13", "ET20KY6.14", "ET20KY7.8", "ET20KY8.9", "ET20OH2.7")

noabs_ll4 <- turcicum_flutriafol_nonegative %>%
  subset(., isolatexbatch %in% list_noabs_ll4)

crude_drc_noabs_ll4 <- ggplot(noabs_ll4,aes(x = as.factor(ppm), y = relative_growth)) +
  stat_summary(fun=mean,position=position_dodge(width=0.95), geom="point") +
  stat_smooth(method = "loess", se = FALSE, color = "black") +
  stat_summary(fun.data = mean_se,position=position_dodge(width=0.95), geom = "errorbar", col= "#4d4d4d") +
  theme_gray() +
  facet_wrap(~isolatexbatch, ncol = 6)+
  guides(fill = FALSE) +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ylim(0,2.50) +
  ggtitle("Isolate with NA in Abs Ec50 LL4 Dose Response Curves") +
  xlab("Concentration ") + ylab("Relative Growth")

crude_drc_noabs_ll4

```


Comparing EC50 we calculated to that which was calculated with the UKY method prior. Checking what we did
```{r}
EC50_data_long <- data_long # making a dataset that is just the isolatexbatch, state, rep and UKY calculated EC50 columns from the original data

EC50_data_long$isolate <- paste0('ET', EC50_data_long$isolate) # adding Et prefix to our isolate names


EC50_data_long$isolate <- gsub(pattern="-", replacement="_", x=EC50_data_long$isolate) # replacing the dash with an underscore

EC50_data_long$isolatexbatch <- interaction(EC50_data_long$isolate, EC50_data_long$batch, drop = TRUE) # making that isolatexbatch column for unique test identifier

EC50_data_long$ppm <- gsub(pattern = " ug/ml", replacement = "", x = EC50_data_long$ppm) # getting rid of " ug/ml" suffix, so that data will be able to read as numeric. important for EC50 calculations


EC50_data_UKY <- select(EC50_data_long, isolatexbatch, state, rep, EC50) # removing the EC50 column from this long data set, we will calculate new ones further down with a model that works best for the isolates fungicide x growth interaction

final_EC50_data_UKY <- EC50_data_UKY %>%
  group_by(isolatexbatch) %>% # grouping by unique isolatexbatch identifier
  mutate(mean_EC50 = mean(EC50)) %>% # making a column of mean EC50 values for each isolatexbatch entry
  select(., select = -c(EC50, rep)) %>% #removing hte EC50 and rep columns
  filter(! duplicated(isolatexbatch)) # removing duplicated results from the dataframe

myEC50_and_UKYEC50_commpare <- merge(both_models_ec50, final_EC50_data_UKY, by="isolatexbatch", all=TRUE) # combining our data set with relate, and absolute EC50 calculations with the EC50 values determined by UKY.

```

Broad comparison of data EC50 Ranges for each dataset, summary metrics, etc.
```{r}
EC50s_only <- myEC50_and_UKYEC50_commpare %>%
  select(., select = -c(isolatexbatch, state))

pander::pander(summary(EC50s_only))

```

Same thing but by state now
```{r, eval=FALSE}
EC50s_by_state <- myEC50_and_UKYEC50_commpare %>%
  filter(!is.na(Absolute.EC50.estimate))%>%
  select(., select = -c(isolatexbatch)) %>%
  group_by(state) %>%
  mutate(Mean_abs_ec50 = mean(Absolute.EC50.estimate), # not working because these now have either a "_ll4" or "w24" suffix
         sd_abs_ec50 = sd(Absolute.EC50.estimate),
         Mean_rel_ec50 = mean(Relative.EC50.estimate),
         sd_rel_ec50 = sd(Relative.EC50.estimate),
         Mean_UKY_ec50 = mean(mean_EC50),
         sd_UKY_ec50 = sd(mean_EC50),
         N_tested = n()) %>%
  select(., select = -c(Absolute.EC50.estimate, Relative.EC50.estimate, mean_EC50)) %>%
  filter(! duplicated(state)) %>%
  select(state, N_tested, Mean_abs_ec50, sd_abs_ec50, Mean_rel_ec50, sd_rel_ec50, Mean_UKY_ec50, sd_UKY_ec50)


pander::pander(EC50s_by_state)
```

Side by side figure - Abs. EC50
```{r}

myEC50_and_UKYEC50_commpare_summary <- myEC50_and_UKYEC50_commpare %>%
  subset(., select= -c(mean_EC50)) %>%
  separate(., col=isolatexbatch, into=c('isolate', 'batch'), sep='\\.') %>% # this needs to be fixed so that the underscore of some isolates names is not separating them. this syntax should work, but is causing issues
  group_by(isolate) %>%
  summarise(state=state,
          mean_ll4_abs_ec50=mean(Absolute.EC50.estimate_ll4, na.rm=TRUE),
          #sd_ll4_abs_ec50=sd(Absolute.EC50.estimate_ll4, na.rm=TRUE),
          mean_ll4_rel_ec50=mean(Relative.EC50.estimate_ll4, na.rm=TRUE),
          #sd_ll4_rel_ec50=sd(Relative.EC50.estimate_ll4, na.rm=TRUE),
          mean_w24_abs_ec50=mean(Absolute.EC50.estimate_w24, na.rm=TRUE),
          #sd_w24_abs_ec50=sd(Absolute.EC50.estimate_w24, na.rm=TRUE),
          mean_w24_rel_ec50=mean(Relative.EC50.estimate_w24, na.rm=TRUE),
          #sd_w24_rel_ec50=sd(Relative.EC50.estimate_w24, na.rm=TRUE),
          times_tested=n()*2) %>% # n will equal the number of plates which data were taken on for each isolate. 1 experimental run = 2 plates
          unique()
  
myEC50_and_UKYEC50_commpare_summary$fungicide <- "Flutriafol"
unique(myEC50_and_UKYEC50_commpare_summary$isolate)


violin_dist <- ggplot(myEC50_and_UKYEC50_commpare_summary, aes(x=fungicide, y=mean_ll4_abs_ec50)) +
geom_violin(scale="width", size=0.1, position = position_dodge(width = 1.0), trim=TRUE) + 
  geom_point(position=position_jitter(seed = 1, width=0.2), alpha=0.5) + 
  stat_summary(fun = "mean", geom="crossbar", width= 0.5, colour="black") +
  scale_y_log10() +
  theme_gray() +
  theme(axis.text.x = element_blank(),
                     axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
                     axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
                     axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
                     axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
                     legend.text = element_text(size = 15, face = "bold", family = "serif"),
                     legend.key = element_blank(),
                     legend.title = element_text(size = 15, face="bold", family = "serif"),
                     legend.position = "right",
                     strip.text.x = element_text(size = 20, face = "bold", family = "serif"),
                     title = element_text(size = 16, family = "serif")) +
                      #ylim(0,) +
                      ggtitle(bquote("A.)"~LL4~Absolute~EC[50]~of~all~isolates)) +
  labs(x="Flutriafol",y="µg/ml (ppm)")
  
  
Absolute_ec50_box <- ggplot(myEC50_and_UKYEC50_commpare_summary, aes(x=state, y=mean_ll4_abs_ec50)) +
  geom_boxplot() +
  coord_flip() +
  scale_y_log10() +
theme_gray() +
  theme(axis.text.x = element_text(size = 20, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 20, face="bold", family = "serif"),
        legend.position = "none",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle(bquote("B.)"~LL4~Absolute~EC[50]~distribution~by~state)) +
  xlab("State ") + ylab("µg/ml (ppm) Flutriafol")

distribution_figure <- plot_grid(violin_dist, Absolute_ec50_box, ncol=2)

distribution_figure

#ggsave("mean ll4 Absolute Ec50 distribution total and by state_panels_AB.png", plot=distribution_figure, width = 16, height = 12, units = "in")

myEC50_and_UKYEC50_commpare

myEC50_and_UKYEC50_commpare_summary

#write.xlsx(myEC50_and_UKYEC50_commpare_summary, "mean relative and absolute ec50 for all isolates.xlsx")
```

Distribution Histograms for EC50 values
```{r, eval=FALSE, fig.asp=0.8, fig.width=20, out.width="100%", dpi=600}
# LL4 Absolute EC50 distribution
LL4_abs_EC50_hist <- ggplot(myEC50_and_UKYEC50_commpare, aes(x=Absolute.EC50.estimate, fill=state)) +
  geom_histogram(binwidth = 0.5) + #everything grouped within 0.5 ppm EC50 of another
  theme_gray() +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  scale_x_continuous(breaks=c(0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70)) +
  ggtitle("LL.4 model Absolute EC50 distribution") +
  xlab("ppm Flutriafol ") + ylab("Frequency")

#LL4_abs_EC50_hist # there will be a warning on 9 "non-finite values" for the Absolute EC50. These are nine isolates for which we could not calculate and Absolute EC50 value for, we will likely be able to calculate a Relative EC50 (predictive) value for these isolate though. No Absolute EC50 value means that there was no way to determine what concentration would produce 50% growth inhibition, likely somewhat resistant to the compound, therefore we have to extrapolate what the concentration value would be through relative EC50 calculations.

LL4_rel_EC50_hist <- ggplot(myEC50_and_UKYEC50_commpare, aes(x=Relative.EC50.estimate, fill=state)) +
  geom_histogram(binwidth = 0.5) + #everything grouped within 0.5 ppm EC50 of another
  theme_gray() +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  scale_x_continuous(breaks=c(0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70)) +
  ggtitle("LL.4 model Relative EC50 distribution") +
  xlab("ppm Flutriafol ") + ylab("Frequency")

#LL4_rel_EC50_hist

UKY_EC50_hist <- ggplot(myEC50_and_UKYEC50_commpare, aes(x=mean_EC50, fill=state)) +
  geom_histogram(binwidth = 0.5) + #everything grouped within 0.5 ppm EC50 of another
  theme_gray() +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  scale_x_continuous(breaks=c(0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70)) +
  ggtitle("UKY EC50 estimate EC50 distribution") +
  xlab("ppm Flutriafol ") + ylab("Frequency")

#UKY_EC50_hist



all_together <- plot_grid(LL4_abs_EC50_hist, LL4_rel_EC50_hist, UKY_EC50_hist)

all_together

#ggsave("plots with all EC50 estimates together, MSU and KYU.png", plot = all_together, width = 20, height = 16, dpi = 600)

```

Comparison of states, boxplots.
```{r, eval=FALSE, fig.asp=0.8, fig.width=20, out.width="100%", dpi=600}
Absolute_ec50_box <- ggplot(both_models_ec50, aes(x=state, y=Absolute.EC50.estimate_ll4, fill = state)) +
  geom_boxplot() +
  coord_flip() +
theme_gray() +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle("LL4 Absolute EC50 estimate EC50 distribution") +
  xlab("State ") + ylab("ppm Flutriafol")

#Absolute_ec50_box

Relative_ec50_box <- ggplot(both_models_ec50, aes(x=state, y=Relative.EC50.estimate_ll4, fill = state)) +
  geom_boxplot() +
  coord_flip() +
theme_gray() +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle("LL4 Relative EC50 estimate EC50 distribution") +
  xlab("State ") + ylab("ppm Flutriafol")

#Relative_ec50_box

UKY_ec50_box <- ggplot(myEC50_and_UKYEC50_commpare, aes(x=state, y=mean_EC50, fill = state)) +
  geom_boxplot() +
  coord_flip() +
theme_gray() +
  theme(axis.text.x = element_text(size = 9, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 10, face="bold", family = "serif"),
        legend.position = "right",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle("UKY EC50 estimate EC50 distribution") +
  xlab("State ") + ylab("ppm Flutriafol")

#UKY_ec50_box

all_together_box <- plot_grid(Absolute_ec50_box, Relative_ec50_box, UKY_ec50_box)

all_together_box

#ggsave("boxplotsplots with all EC50 estimates together, MSU and KYU.png", plot = all_together_box, width = 20, height = 16, dpi = 600)
```

T-test between EC50 estimate methods
```{r, eval=FALSE}
# Absolute vs Relative EC50, there will be significant differences here as expected
t.test(myEC50_and_UKYEC50_commpare$Absolute.EC50.estimate, myEC50_and_UKYEC50_commpare$Relative.EC50.estimate)

# Absolute vs UKY EC50 estimation method, significant differences as expected
t.test(myEC50_and_UKYEC50_commpare$Absolute.EC50.estimate, myEC50_and_UKYEC50_commpare$mean_EC50)

# Relative vs UKY EC50 estimation method, no significant differences. These methods peroduced similar results.
t.test(myEC50_and_UKYEC50_commpare$Relative.EC50.estimate, myEC50_and_UKYEC50_commpare$mean_EC50)

```

### The method used by UKY to estimate their EC50 values resulted in non-significant differences between those values and the Relative EC50 values calculated here. 
Control isolates tested more than once, how repeatable was this?
```{r}
library(rstatix)

EC50_data_batches <- myEC50_and_UKYEC50_commpare %>%
    separate(col=isolatexbatch, into=c('Isolate', 'batch'), sep='\\.', convert = TRUE, remove = FALSE) %>%
  subset(., Isolate %in% c("ET20KY6", "ET20KY8"))

ET20KY6_data <- EC50_data_batches %>%
  subset(., Isolate == "ET20KY6")

ET20KY6_data_noNA <- EC50_data_batches %>%
  subset(., Isolate == "ET20KY6") %>%
  drop_na()

ET20KY8_data <- EC50_data_batches %>%
  subset(., Isolate == "ET20KY8") 

ET20KY8_data_noNA <- EC50_data_batches %>%
  subset(., Isolate == "ET20KY8") %>%
  drop_na()

#### LL4 model reproducibility ####
Absolute_ec50_ll4_outlier_box <- ggplot(EC50_data_batches, aes(x=Isolate, y=as.numeric(Absolute.EC50.estimate_ll4))) +
  geom_boxplot() +
  theme_gray() +
  theme(axis.text.x = element_text(size = 20, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 20, face="bold", family = "serif"),
        legend.position = "none",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle("Absolute Ec50 outlier detection") +
  xlab("Isolate ") + ylab("µg/ml (ppm) Flutriafol")

Absolute_ec50_ll4_outlier_box # only an outlier with ET20KY8, 2 NA's from KY6, 1 NA from KY8, so 2/9 reps were not necessarily reproducible for each isolate

Relative_ec50_ll4_outlier_box <- ggplot(EC50_data_batches, aes(x=Isolate, y=as.numeric(Relative.EC50.estimate_ll4))) +
  geom_boxplot() +
  theme_gray() +
  theme(axis.text.x = element_text(size = 20, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 20, face="bold", family = "serif"),
        legend.position = "none",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle("Relative Ec50 outlier detection") +
  xlab("Isolate ") + ylab("µg/ml (ppm) Flutriafol")

Relative_ec50_ll4_outlier_box # 1 outlier with KY6 and 2 with KY8, no NA's. so 1/9 reps with KY6 and 2/9 reps with KY6 were not necessarily reproducible for each isolate 
#### W2.4 reproducibility ####
Absolute_ec50_w24_outlier_box <- ggplot(EC50_data_batches, aes(x=Isolate, y=as.numeric(Absolute.EC50.estimate_w24))) +
  geom_boxplot() +
  theme_gray() +
  theme(axis.text.x = element_text(size = 20, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 20, face="bold", family = "serif"),
        legend.position = "none",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle("Absolute Ec50 outlier detection") +
  xlab("Isolate ") + ylab("µg/ml (ppm) Flutriafol")

Absolute_ec50_w24_outlier_box # 1 outlier for both KY6 and KY8, both also have 1 NA

Relative_ec50_w24_outlier_box <- ggplot(EC50_data_batches, aes(x=Isolate, y=as.numeric(Relative.EC50.estimate_w24))) +
  geom_boxplot() +
  theme_gray() +
  theme(axis.text.x = element_text(size = 20, face = "bold", angle=45, hjust=1, family = "serif"),
        axis.text.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.x = element_text(size = 20, face = "bold", family = "serif"),
        axis.title.y = element_text(size = 20, face = "bold", family = "serif"),
        axis.line.x = element_line(colour = 'gray', size=0.5, linetype='solid'),
        axis.line.y = element_line(colour = 'gray', size=0.5, linetype='solid'),
        legend.text = element_text(size = 10, face = "bold", family = "serif"),
        legend.key = element_blank(),
        legend.title = element_text(size = 20, face="bold", family = "serif"),
        legend.position = "none",
        strip.text.x = element_text(size = 10, face = "bold", family = "serif"),
        title = element_text(size = 16, family = "serif")) +
  ggtitle("Relative Ec50 outlier detection") +
  xlab("Isolate ") + ylab("µg/ml (ppm) Flutriafol")

Relative_ec50_w24_outlier_box #  1 outlier for KY6, 2 outliers for KY8

#### outlier and NA summary ####
# absolute EC50 ll4 =
# relative EC50 ll4 =
# absolute EC50 w24 =
# relative EC50 w24 =


# Wilcoxon test will not work as we only have one observation per batch for the reproducibility isolates
ET20KY6_KY8_reproduce_ll4 <- EC50_data_batches %>%
  group_by(Isolate) %>%
  summarize(mean_ll4 = mean(as.numeric(Absolute.EC50.estimate_ll4), na.rm=TRUE),
            sd_ll4 = sd(as.numeric(Absolute.EC50_ll4), na.rm=TRUE),
            plus3_stdv_ll4 = mean(as.numeric(Absolute.EC50.estimate_ll4), na.rm=TRUE)+(3*sd(Absolute.EC50_ll4, na.rm=TRUE)),
            minus3_stdv_ll4 = mean(as.numeric(Absolute.EC50.estimate_ll4), na.rm=TRUE)-(3*sd(Absolute.EC50_ll4)))

ET20KY8_noNA_reproduce <- wilcox_test(Absolute.EC50.estimate_ll4 ~ isolatexbatch, paired=TRUE, data = ET20KY8_data_noNA)

#set a 95% confidence interval here an see if any are outside of that (some will be as they are NA, also do it for relative EC50 so you can at least say "all relative EC50 were within the 95% confidence interval, however, XX of 9 replicates were outside the confidence interval for absolute EC50 calculations")

```
  